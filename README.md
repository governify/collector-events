# Governify Events Collector
[![Node.js CI](https://github.com/governify/collector-events/workflows/Node.js%20CI/badge.svg?branch=master)](https://github.com/governify/collector-events/actions)
[![Coverage Status](https://coveralls.io/repos/github/governify/collector-events/badge.svg)](https://coveralls.io/github/governify/collector-events)
<a href="https://standardjs.com"><img src="https://img.shields.io/badge/code_style-semistandard-brightgreen.svg" alt="Standard - JavaScript Style Guide"></a>
[![Conventional Commits](https://img.shields.io/badge/Conventional%20Commits-1.0.0-yellow.svg)](https://conventionalcommits.org)


## Overview
Events collector is a component of the Governify ecosystem.

This server was generated by the [oas-generator](https://github.com/isa-group/oas-generator) project.

### Running the server
To run the server, run:

```
npm start
```

This project leverages the mega-awesome [oas-tools](https://github.com/isa-group/oas-tools) middleware which does most all the work.

## Configuration needed
For the server to run, it is needed to include the json file `/configurations/scope-manager/authKeys.json`. The governify-project-bluejay-infrastructure is configured to insert this file for you but if you need to run the server you can obtain the file from there.
## Escalability
The file `./configurations/sourcesManager.json` cointains information about needed parameters for the collector needs for fetching API data. The structure is fairly simple:

The file is a JSON containing 3 objects:
- `endpoints`

  It stores the relation between and actual metric input and the endpoint of the API it connects to.
  This object contains as many objects inside as APIs the collector has integrated into it. Each object contains the relation between the data the metric needs to compute and the endpoint where the collector can find that data.
  ```javascript
  ./configurations/sourcesManager.json
  
  "endpoints": {
    "github": {
      "events": "/repos/{github.repoOwner}/{github.repository}/events"
    },
    "pivotal": {
      "activity": "/projects/{pivotal.project}/activity"
    },
    "heroku": {
      "releases": "/apps/{heroku.project}/releases"
    }
  }
  ```
  The endpoints can have integrations indicated between {}. Theese will be replaced with the actual project information to fetch the data.
- `substitutions`

  Some metrics, when looking for the match with the payload the APIs return, might need to look for the user of a repo for example. In this array it is possible to indicate the relation between an %STRING% string on a metric with an actual integration
  ```javascript
  ./configurations/sourcesManager.json
  
  "substitutions": [
    "GITHUB.REPO_OWNER->github.repoOwner"
  ]
  ```
  In this substitution any %GITHUB.REPO_OWNER% string inside a metric will be replaced with the github.repoOwner integration of the  project.
- `payloadDates`

  This configuration is changed whenever a new API is integrated in the system. Metrics have nothing to do with this as long as it is configured correctly on integration. It tells each API fetcher where can it find the timestamp of the event. For example:

  For this shortened pivotal activity payload:
  ```javascript
  ./configurations/sourcesManager.json
  
  {
    "kind": "story_update_activity",
    "guid": "2242320_415",
    "project_version": 415,
    "message": "César García Pascual started this feature",
    ...

    ...
    "performed_by": {
      "kind": "person",
      "id": 3296464,
      "name": "César García Pascual",
      "initials": "cgp"
    },
    "occurred_at": "2020-01-27T12:43:51Z"
  }
  ```
  The timestamp of this event is `2020-01-27T12:43:51Z` indicated on the field `occurred_at` at the end of the payload. So the sources manager configuration will look like this:

  ```javascript
  ./configurations/sourcesManager.json
  
  "payloadDates": {
    "pivotal": "occurred_at"
  }
  ```


  
### Collector Metric-Config Example
Having this simplified metric concerning the APIs sources:
 
```javascript
METRIC

"element": {
  "percentage": {
    "related": {
      "github": {
        "events": {
          "type": "PullRequestEvent",
          "payload": {
            "action": "closed",
            "pull_request": {
              "base": {
                "label": "%GITHUB.REPO_OWNER%:master"
              }
            }
          }
        }
      },
      "window": 86400
    }
  }
},
"event": {
  "pivotal": {
    "activity": {
      "highlight": "accepted"
    }
  }
}
```
 
The collector will fetch information from 2 sources. Looking at the GitHub request:
```javascript
METRIC

"github": {
  "events": {
    "type": "PullRequestEvent",
    "payload": {
      "action": "closed",
      "pull_request": {
        "base": {
          "label": "%GITHUB.REPO_OWNER%:master"
        }
      }
    }
  }
}
```
The system will fetch the events information. Going to the endpoints configuration:

```javascript
ENDPOINTS

"github": {
  "events": "/repos/{github.repoOwner}/{github.repository}/events"
}
```
The events information corresponds to the endpoint `/repos/{github.repoOwner}/{github.repository}/events`. The system will substitute `{github.repoOwner}` and `{github.repository}` with the information extracted from the Scope Manager for the project.

---

Looking at the most nested part of the metric we can see a % item:
```javascript
METRIC

"label": "%GITHUB.REPO_OWNER%:master"
```
Going to the substitutions configuration:
```javascript
SUBSTITUTIONS

"GITHUB.REPO_OWNER->github.repoOwner"
```

The system will replace %GITHUB.REPO_OWNER% with the information extracted from the Scope Manager for the project.

